.PHONY: all setup run clean

# Default: chá»‰ cáº§n gÃµ "make"
all: check-and-run

# Check deps â†’ setup náº¿u thiáº¿u â†’ run
check-and-run:
	@if [ ! -d "venv" ] || ! python3 -c "from picamera2 import Picamera2" 2>/dev/null || ! pkg-config --exists libavformat 2>/dev/null; then \
		echo "âš ï¸  Missing dependencies, running setup..."; \
		$(MAKE) setup; \
	fi
	@$(MAKE) run

# Setup: cÃ i system deps + venv + python packages
setup:
	@echo "ðŸ“¦ Installing system dependencies..."
	@sudo apt update -qq
	@sudo apt install -y python3-picamera2 \
		libavformat-dev libavcodec-dev libavdevice-dev \
		libavutil-dev libavfilter-dev libswscale-dev \
		libswresample-dev pkg-config
	@echo "âœ… System deps installed"
	@echo "ðŸ“¦ Creating venv..."
	@rm -rf venv
	@python3 -m venv --system-site-packages venv
	@echo "ðŸ“¥ Installing Python packages..."
	@bash -c "source venv/bin/activate && pip install -q --upgrade pip && pip install -q -r requirements.txt"
	@mkdir -p data
	@echo "âœ… Setup complete"

# Run app
run:
	@if [ ! -d "venv" ]; then \
		echo "âŒ venv not found. Run 'make setup' first."; \
		exit 1; \
	fi
	@echo "ðŸŽ¯ Starting server..."
	@bash -c "source venv/bin/activate && python3 app.py"

# Clean cache
clean:
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@echo "âœ… Clean complete"
