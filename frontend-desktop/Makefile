.PHONY: all setup run clean test help

# Default: chá»‰ cáº§n gÃµ "make"
all: check-and-run

# Help - Hiá»ƒn thá»‹ cÃ¡c commands
help:
	@echo "ðŸ“š ParkAI Desktop - Available Commands:"
	@echo ""
	@echo "  make          - Setup (náº¿u cáº§n) vÃ  cháº¡y app"
	@echo "  make setup    - CÃ i Ä‘áº·t dependencies vÃ  táº¡o venv"
	@echo "  make run      - Cháº¡y desktop app"
	@echo "  make test     - Test PyQt6 installation"
	@echo "  make clean    - XÃ³a cache vÃ  __pycache__"
	@echo "  make help     - Hiá»ƒn thá»‹ help nÃ y"
	@echo ""

# Check deps â†’ setup náº¿u thiáº¿u â†’ run
check-and-run:
	@if [ ! -d "venv" ] || ! venv/bin/python3 -c "from PyQt6.QtWidgets import QApplication" 2>/dev/null; then \
		echo "âš ï¸  Missing dependencies, running setup..."; \
		$(MAKE) setup; \
	fi
	@$(MAKE) run

# Setup: cÃ i system deps + venv + python packages
setup:
	@echo "ðŸ“¦ Installing system dependencies..."
	@sudo apt update -qq
	@sudo apt install -y -qq \
		python3-pip \
		python3-venv \
		python3-dev \
		python3-pyqt6 \
		python3-pyqt6.qtwebengine \
		libxcb-xinerama0 \
		libxcb-cursor0 \
		libxkbcommon-x11-0 \
		libegl1 \
		libgl1-mesa-glx \
		libglib2.0-0 \
		libdbus-1-3 \
		libfontconfig1 \
		libfreetype6 \
		libx11-6 \
		libx11-xcb1
	@echo "âœ… System deps installed"
	@echo ""
	@echo "ðŸ“¦ Creating virtual environment (with system packages)..."
	@rm -rf venv
	@python3 -m venv --system-site-packages venv
	@echo "âœ… Virtual environment created"
	@echo ""
	@echo "ðŸ“¥ Installing Python packages..."
	@bash -c "source venv/bin/activate && pip install -q --upgrade pip && pip install -q -r requirements.txt"
	@echo "âœ… Python packages installed"
	@echo ""
	@echo "ðŸŽ‰ Setup complete! Run 'make run' to start the app."

# Run app
run:
	@if [ ! -d "venv" ]; then \
		echo "âŒ venv not found. Run 'make setup' first."; \
		exit 1; \
	fi
	@echo "ðŸš€ Starting ParkAI Desktop..."
	@bash -c "source venv/bin/activate && python3 main.py"

# Test PyQt6 installation
test:
	@echo "ðŸ§ª Testing PyQt6 installation..."
	@if [ ! -d "venv" ]; then \
		echo "âŒ venv not found. Run 'make setup' first."; \
		exit 1; \
	fi
	@bash -c "source venv/bin/activate && python3 -c 'from PyQt6.QtWidgets import QApplication; print(\"âœ… PyQt6 OK\")'"
	@bash -c "source venv/bin/activate && python3 -c 'import requests; print(\"âœ… requests OK\")'"
	@bash -c "source venv/bin/activate && python3 -c 'import websocket; print(\"âœ… websocket-client OK\")'"
	@echo "ðŸŽ‰ All dependencies OK!"

# Clean cache
clean:
	@echo "ðŸ§¹ Cleaning cache..."
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	@echo "âœ… Clean complete"

# Clean all (including venv)
clean-all: clean
	@echo "ðŸ§¹ Removing virtual environment..."
	@rm -rf venv
	@echo "âœ… All clean!"
